<%= form_tag "#{ENV['API_PATH']}/defective_materials", authenticity_token: false, remote: true, id: 'dmr_form' do %>

<div class='row'>
  <div class='col' style='margin: 0 auto; min-width: 50%; max-width: 1200px;'>
    <div id='DMR_form' class='card-body bg-gold shine'>
      <div class='card-text-area'>
        <div class='form-row roundxed-container mt-0 mb-2 pb-0' style= 'backdground-color: #000000d4 !important;'>
          <div class='col pb-0' style='color: black;'>
            <div class='form-group'>
              <%= label 'shop_order', 'Shop Order #' %>
              <div class='input-group'>
                <%= number_field_tag 'shop_order', nil, { class: 'form-control', onchange: "get_so_info('#{request_path}', this.value);",tabindex: "1" }%>
                <span class='input-group-append'>
                  <%= button_tag fa_icon('refresh'), type: :button, onclick: "get_so_info('#{request_path}', $('#shop_order').val());", class: "btn btn-gold d-inline-block", remote: true %>
                </span>
              </div>
            </div>
          </div>
          <div class='col-xs-12 col-sm-12 col-md-12 col-lg-6 col-xl-6 pb-0 dmr_hidden_fields' id='so_info_area' style='display: none;'>
          </div>
        </div>
        <div class='dmr_hidden_fields' style='<%= 'display: none;' %>'>
          <div class='form-row mt-0 mb-0 pb-0'>
            <div class='col-xs-12 col-sm-6 col-md-3 col-lg-3 col-xl-3'>
              <%= hidden_field_tag :shop_order_id %>
              <div class='form-group'>
                <%= label :number, 'DMR #' %>
                <%= text_field_tag :number, nil, { readonly: true, class: 'form-control' } %>
              </div>
              <div class='form-group'>
                <%= label :purchase_order_numbers, 'PO #(s)'%>
                <%= text_field_tag :purchase_order_numbers, nil, { readonly: true, rows: 1, class: 'form-control' } %>
              </div>
            </div>
            <div class='col-xs-12 col-sm-6 col-md-3 col-lg-3 col-xl-3'>
              <div class='form-group'>
                <%= label :weight, 'Weight' %>
                <%= number_field_tag :weight, {}, { placeholder: 'in pounds', class: 'form-control' } %>
              </div>
              <div class='form-group'>
                <%= label :pieces, 'Pieces' %>
                <%= number_field_tag :pieces, {}, { class: 'form-control' } %>
              </div>
            </div>
            <div class='col-xs-12 col-sm-6 col-md-3 col-lg-3 col-xl-3'>
              <div class='form-group'>
                <%= label :created_at, 'Date', { class: 'form-label required' } %>
                <%= date_field_tag :created_at, '', { class: 'form-control' } %>
              </div>
              <div class='form-group'>
                <%= label :employee_num, 'Sent by' %>
                <%= select_tag :employee_num, options_for_select(User.all.map{ |x| [x.username, x.employee_number]}, main_app.scope.request.env['warden'].user.employee_number), { class:'form-control' } %>
              </div>
            </div>
            <div class='col-xs-12 col-sm-6 col-md-3 col-lg-3 col-xl-3'>
              <div class='form-group'>
                <%= label :found_when, 'Found When' %>
                <%= select_tag :found_when, {}, { class:'form-control' } %>
              </div>
              <div class='form-group'>
                <%= label :part_disposition, 'Part disposition' %>
                <%= select_tag :part_disposition, {}, { class:'form-control' } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class='dmr_hidden_fields' style='<%= 'display: none;' %>'>
      <div class='card-body mt-3 mb-3 bg-red'>
        <div class='card-text-area'>
          <div class='form-row mt-0 pb-0'>
            <div class='col-12 col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6'>
              <div class='container-fluid text-gold rounded-container px-3 pt-3 pb-3 mt-0 mb-3' style='background-color: #212529e6 !important;'>
                <div class='text-center'>
                  <h4 class='text-center text-white' style='display: inline-block; border-style: none none solid none; border-width: 2px; border-color: #c3252f;'>
                    Notified
                  </h4>
                </div>
                <div class='form-group'>
                  <%= label :contact_id, 'Contact' %>
                  <div class='input-group'>
                    <%= select_tag :contact_id, {}, { id: 'contact_id', class: 'form-control', onchange: "$('#contact_text_area').empty().append($(this.options[this.selectedIndex]).data('partial'));" } %>
                    <span class='input-group-append'>
                      <button type="button" class="btn btn-outline-danger rounded-right" data-toggle="modal" data-target="#contact_modal">
                        <%= fa_icon('plus') %>
                      </button>
                    </span>
                  </div>
                </div>
                <div id='contact_text_area'></div>
                <div class='form-group'>
                  <%= label :notified_by, 'Notified via' %>
                  <%= select_tag :notified_by, {}, {id: 'notified_by', class: 'form-control'} %>
                </div>
                <div class='form-group'>
                  <%= label :customer_instruction, 'Customer instructions' %>
                  <%= text_area_tag :customer_instruction, nil, { class: 'form-control' } %>
                </div>
              </div>
            </div>
            <div class='col-12 col-md-6 col-lg-6 col-xl-6'>
              <div class='form-group'>
                <%= label :defect_description, 'Defect description' %>
                <%= text_area_tag :defect_description, nil, { class: 'form-control' } %>
              </div>
              <div class='form-group'>
                <%= label :corrective_action, 'Corrective action' %>
                <%= text_area_tag :corrective_action, nil, { class: 'form-control' } %>
              </div>
              <div class='form-group'>
                <%= label :address_id, 'Send to' %>
                <div class='input-group'>
                  <%= select_tag :address_id, {}, { id: 'address_id', class: 'form-control', onchange: "$('#address_text_area').empty().append($(this.options[this.selectedIndex]).data('partial'));" } %>
                  <span class='input-group-append'>
                    <button type="button" class="btn btn-outline-danger rounded-right" data-toggle="modal" data-target="#address_modal">
                      <%= fa_icon('plus') %>
                    </button>
                  </span>
                </div>
              </div>
              <div class='w-100'></div>
              <div id='address_text_area'></div>
              <div id='dmr_sent_radio_buttons' class='form-control mb-3 mt-3'>
                <%= label :samples_sent, 'Samples sent?' %>
                <%= radio_button_tag :samples_sent, '1' %>
                yes
                <%= radio_button_tag :samples_sent, '0', true %>
                no
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class='card-body mt-3 mb-3 bg-gold'>
        <div class='card-text-area'>
          <div class='col-12 rounded-container text-gold mb-0 mt-0' style='background-color: #212529e6;'>
            <%= label :files, 'Files' %>
            <%= file_field_tag 'files[]',{ multiple: true, class: 'filepond' } %>
          </div>
          <div class='w-100 text-center'>
          <%= button_tag 'Create Defective Material Report', class: 'mt-3 btn bg-gold', onclick: "Rails.fire(form, 'submit');", data: { disable_with: "<i class='fa fa-spinner fa-spin'></i> thinking..." } %>
        </div>
      </div>
    </div>
  </div>
<div>
<% end -%>

<script>
  FilePond.registerPlugin(FilePondPluginFileEncode);
  FilePond.registerPlugin(FilePondPluginImageExifOrientation);
  FilePond.registerPlugin(FilePondPluginImagePreview);
  FilePond.registerPlugin(FilePondPluginFileValidateType);
  
  FilePond.parse(document.body);

  FilePond.setOptions({
    acceptedFileTypes: ['image/*'],
    fileValidateTypeLabelExpectedTypes: 'must be an image'
  })

  $("#dmr_form").on("ajax:success", function(data){
  });
  $("#dmr_form").on("ajax:error", function(event){
  // remove all is-invalid and invalid-feedback
    clear_validation_errors();
  // add all current errors
    render_validation_errors(event.detail[0], '');
  // mark non-error fields valid
    $.each($(`#dmr_form`).find(`.form-control:not(.is-invalid, .modal-body, .modal-body *)`), function(index, input){
      $(input).addClass('is-valid')
    })
  });
</script>